{% extends "base.html" %}

{% block title %}Database - FinanceFlow Pro{% endblock %}

{% block extra_styles %}
<style>
    .file-list {
        background: var(--bg-primary);
        border: 1px solid var(--border-light);
        border-radius: var(--radius-lg);
        overflow: hidden;
    }
    
    .file-item {
        padding: 20px;
        border-bottom: 1px solid var(--border-light);
        display: flex;
        align-items: center;
        justify-content: space-between;
        transition: background 0.2s;
    }
    
    .file-item:last-child {
        border-bottom: none;
    }
    
    .file-item:hover {
        background: var(--bg-secondary);
    }
    
    .file-info {
        flex: 1;
    }
    
    .file-name {
        font-weight: 600;
        color: var(--text-primary);
        margin-bottom: 4px;
    }
    
    .file-meta {
        font-size: 12px;
        color: var(--text-secondary);
    }
    
    .file-stats {
        display: flex;
        gap: 20px;
        margin-right: 20px;
    }
    
    .file-stat {
        text-align: center;
    }
    
    .file-stat-value {
        font-weight: 700;
        color: var(--text-primary);
    }
    
    .file-stat-label {
        font-size: 11px;
        color: var(--text-tertiary);
    }
    
    .danger-zone {
        background: var(--bg-primary);
        border: 2px solid var(--danger);
        border-radius: var(--radius-lg);
        padding: 24px;
        margin-top: 32px;
    }
    
    .danger-title {
        color: var(--danger);
        font-weight: 700;
        margin-bottom: 16px;
        display: flex;
        align-items: center;
        gap: 8px;
    }
    
    .modal-content {
        border-radius: var(--radius-lg);
        border: none;
    }
    
    .modal-header {
        border-bottom: 1px solid var(--border-light);
    }
    
    .modal-footer {
        border-top: 1px solid var(--border-light);
    }
</style>
{% endblock %}

{% block content %}
<div class="container py-4">
    
    <!-- Page Header -->
    <div class="page-header">
        <h1 class="page-title">Database Management</h1>
        <p class="page-subtitle">Manage uploaded files and database records</p>
    </div>
    
    <!-- Uploaded Files -->
    <div class="card-clean mb-4">
        <h5 class="section-title">Uploaded Files</h5>
        <div class="file-list" id="filesList">
            <!-- Populated by JavaScript -->
        </div>
        <div id="emptyFiles" style="display: none; text-align: center; padding: 40px; color: var(--text-secondary);">
            <i class="fas fa-folder-open" style="font-size: 48px; color: var(--gray-300); margin-bottom: 12px;"></i>
            <p>No files uploaded yet</p>
        </div>
    </div>
    
    <!-- Danger Zone -->
    <div class="danger-zone">
        <div class="danger-title">
            <i class="fas fa-exclamation-triangle"></i>
            Danger Zone
        </div>
        <p style="color: var(--text-secondary); margin-bottom: 16px;">
            These actions are irreversible. Please be certain before proceeding.
        </p>
        <button class="btn-danger-clean" onclick="confirmClearAll()">
            <i class="fas fa-trash-alt me-2"></i>Clear All Data
        </button>
    </div>
    
</div>

<!-- Confirm Clear Modal -->
<div class="modal fade" id="confirmModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Confirm Action</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p id="modalMessage"></p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn-danger-clean" id="confirmBtn">Delete</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
let currentAction = null;
let currentFilename = null;

function loadFiles() {
    fetch('/api/database/files')
        .then(res => res.json())
        .then(files => {
            if (files.length === 0) {
                document.getElementById('emptyFiles').style.display = 'block';
                document.querySelector('.file-list').style.display = 'none';
                return;
            }
            
            const filesList = document.getElementById('filesList');
            filesList.innerHTML = files.map(file => {
                const firstDate = file.first_date ? new Date(file.first_date).toLocaleDateString() : 'N/A';
                const lastDate = file.last_date ? new Date(file.last_date).toLocaleDateString() : 'N/A';
                
                return `
                    <div class="file-item">
                        <div class="file-info">
                            <div class="file-name">
                                <i class="fas fa-file-alt me-2"></i>${file.filename}
                            </div>
                            <div class="file-meta">
                                ${file.bank} • ${firstDate} to ${lastDate}
                            </div>
                        </div>
                        <div class="file-stats">
                            <div class="file-stat">
                                <div class="file-stat-value">${file.count}</div>
                                <div class="file-stat-label">Transactions</div>
                            </div>
                            <div class="file-stat">
                                <div class="file-stat-value">₦${file.total.toLocaleString(undefined, {minimumFractionDigits: 0, maximumFractionDigits: 0})}</div>
                                <div class="file-stat-label">Total</div>
                            </div>
                        </div>
                        <button class="btn-danger-clean btn-sm" onclick="confirmDeleteFile('${file.filename}')">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                `;
            }).join('');
        })
        .catch(err => {
            document.getElementById('emptyFiles').style.display = 'block';
            document.querySelector('.file-list').style.display = 'none';
        });
}

function confirmDeleteFile(filename) {
    currentAction = 'deleteFile';
    currentFilename = filename;
    document.getElementById('modalMessage').textContent = `Are you sure you want to delete all transactions from "${filename}"? This action cannot be undone.`;
    new bootstrap.Modal(document.getElementById('confirmModal')).show();
}

function confirmClearAll() {
    currentAction = 'clearAll';
    document.getElementById('modalMessage').textContent = 'Are you sure you want to delete ALL transactions from the database? This action cannot be undone.';
    new bootstrap.Modal(document.getElementById('confirmModal')).show();
}

document.getElementById('confirmBtn').addEventListener('click', () => {
    if (currentAction === 'clearAll') {
        clearAll();
    } else if (currentAction === 'deleteFile') {
        deleteFile(currentFilename);
    }
});

function clearAll() {
    fetch('/api/database/clear', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' }
    })
    .then(res => res.json())
    .then(data => {
        if (data.success) {
            alert(`Successfully deleted ${data.deleted} transactions`);
            location.reload();
        } else {
            alert('Error: ' + data.error);
        }
    });
}

function deleteFile(filename) {
    fetch('/api/database/delete-file', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ filename })
    })
    .then(res => res.json())
    .then(data => {
        if (data.success) {
            alert(`Successfully deleted ${data.deleted} transactions`);
            location.reload();
        } else {
            alert('Error: ' + data.error);
        }
    });
}

window.addEventListener('load', loadFiles);
</script>
{% endblock %}
