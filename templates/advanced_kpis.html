{% extends "base.html" %}

{% block title %}Advanced KPIs - FinanceFlow{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- Header -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <h1 class="h3 mb-1">Advanced KPIs Dashboard</h1>
                    <p class="text-muted mb-0">Comprehensive financial performance metrics and insights</p>
                </div>
                <div class="d-flex gap-2">
                    <select id="timeFilter" class="form-select" style="width: auto;">
                        <option value="7">Last 7 days</option>
                        <option value="30" selected>Last 30 days</option>
                        <option value="90">Last 90 days</option>
                        <option value="0">All time</option>
                    </select>
                    <button id="refreshKPIs" class="btn btn-primary">
                        <i class="fas fa-sync-alt me-1"></i> Refresh
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Loading State -->
    <div id="loadingState" class="text-center py-5" style="display: none;">
        <div class="spinner-border text-primary" role="status">
            <span class="visually-hidden">Loading...</span>
        </div>
        <p class="mt-3 text-muted">Calculating KPIs...</p>
    </div>

    <!-- KPI Results -->
    <div id="kpiResults" style="display: none;">
        <!-- Key Metrics Row -->
        <div class="row mb-4">
            <div class="col-md-3">
                <div class="card bg-primary text-white">
                    <div class="card-body">
                        <div class="d-flex justify-content-between">
                            <div>
                                <h6 class="card-title text-white-50">Total Revenue</h6>
                                <h4 id="totalRevenue" class="mb-0">₦0</h4>
                                <small id="revenueGrowth" class="text-white-50">+0%</small>
                            </div>
                            <div class="align-self-center">
                                <i class="fas fa-coins fa-2x opacity-75"></i>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card bg-success text-white">
                    <div class="card-body">
                        <div class="d-flex justify-content-between">
                            <div>
                                <h6 class="card-title text-white-50">Total Transactions</h6>
                                <h4 id="totalTransactions" class="mb-0">0</h4>
                                <small id="transactionGrowth" class="text-white-50">+0%</small>
                            </div>
                            <div class="align-self-center">
                                <i class="fas fa-chart-line fa-2x opacity-75"></i>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card bg-info text-white">
                    <div class="card-body">
                        <div class="d-flex justify-content-between">
                            <div>
                                <h6 class="card-title text-white-50">Unique Customers</h6>
                                <h4 id="uniqueCustomers" class="mb-0">0</h4>
                                <small id="newCustomers" class="text-white-50">0 new</small>
                            </div>
                            <div class="align-self-center">
                                <i class="fas fa-users fa-2x opacity-75"></i>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card bg-warning text-white">
                    <div class="card-body">
                        <div class="d-flex justify-content-between">
                            <div>
                                <h6 class="card-title text-white-50">ARPU</h6>
                                <h4 id="arpu" class="mb-0">₦0</h4>
                                <small id="retentionRate" class="text-white-50">0% retention</small>
                            </div>
                            <div class="align-self-center">
                                <i class="fas fa-dollar-sign fa-2x opacity-75"></i>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Charts Row -->
        <div class="row mb-4">
            <div class="col-lg-6">
                <div class="card">
                    <div class="card-header">
                        <h5 class="card-title mb-0">Revenue by Channel</h5>
                        <p class="text-muted mb-0">Performance across payment channels</p>
                    </div>
                    <div class="card-body">
                        <canvas id="channelChart" height="200"></canvas>
                    </div>
                </div>
            </div>
            <div class="col-lg-6">
                <div class="card">
                    <div class="card-header">
                        <h5 class="card-title mb-0">Day of Week Analysis</h5>
                        <p class="text-muted mb-0">Revenue distribution by day</p>
                    </div>
                    <div class="card-body">
                        <canvas id="dowChart" height="200"></canvas>
                    </div>
                </div>
            </div>
        </div>

        <!-- Performance Tables -->
        <div class="row mb-4">
            <div class="col-lg-6">
                <div class="card">
                    <div class="card-header">
                        <h5 class="card-title mb-0">Channel Performance</h5>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-sm">
                                <thead>
                                    <tr>
                                        <th>Channel</th>
                                        <th>Revenue</th>
                                        <th>Share</th>
                                        <th>Avg TX</th>
                                    </tr>
                                </thead>
                                <tbody id="channelTable">
                                    <!-- Populated by JavaScript -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-lg-6">
                <div class="card">
                    <div class="card-header">
                        <h5 class="card-title mb-0">Bank Performance</h5>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-sm">
                                <thead>
                                    <tr>
                                        <th>Bank</th>
                                        <th>Revenue</th>
                                        <th>Share</th>
                                        <th>Avg TX</th>
                                    </tr>
                                </thead>
                                <tbody id="bankTable">
                                    <!-- Populated by JavaScript -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Top Customers -->
        <div class="row">
            <div class="col-lg-6">
                <div class="card">
                    <div class="card-header">
                        <h5 class="card-title mb-0">Top Customers by Revenue</h5>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-sm">
                                <thead>
                                    <tr>
                                        <th>Rank</th>
                                        <th>Customer</th>
                                        <th>Revenue</th>
                                    </tr>
                                </thead>
                                <tbody id="topCustomersRevenue">
                                    <!-- Populated by JavaScript -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-lg-6">
                <div class="card">
                    <div class="card-header">
                        <h5 class="card-title mb-0">Top Customers by Transactions</h5>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-sm">
                                <thead>
                                    <tr>
                                        <th>Rank</th>
                                        <th>Customer</th>
                                        <th>Transactions</th>
                                    </tr>
                                </thead>
                                <tbody id="topCustomersTransactions">
                                    <!-- Populated by JavaScript -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Error State -->
    <div id="errorState" class="text-center py-5" style="display: none;">
        <div class="alert alert-danger">
            <i class="fas fa-exclamation-triangle fa-2x mb-3"></i>
            <h5>KPI Calculation Failed</h5>
            <p id="errorMessage" class="mb-0">Unable to calculate KPIs. Please try again.</p>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
let channelChart = null;
let dowChart = null;

function loadKPIs() {
    const days = document.getElementById('timeFilter').value;
    const loadingState = document.getElementById('loadingState');
    const kpiResults = document.getElementById('kpiResults');
    const errorState = document.getElementById('errorState');
    
    // Show loading
    loadingState.style.display = 'block';
    kpiResults.style.display = 'none';
    errorState.style.display = 'none';
    
    fetch(`/api/advanced-kpis?days=${days}`)
        .then(res => res.json())
        .then(data => {
            loadingState.style.display = 'none';
            
            if (data.error) {
                errorState.style.display = 'block';
                document.getElementById('errorMessage').textContent = data.error;
                return;
            }
            
            displayKPIs(data);
            kpiResults.style.display = 'block';
        })
        .catch(err => {
            console.error('Error loading KPIs:', err);
            loadingState.style.display = 'none';
            errorState.style.display = 'block';
            document.getElementById('errorMessage').textContent = err.message;
        });
}

function displayKPIs(data) {
    // Update key metrics
    document.getElementById('totalRevenue').textContent = '₦' + data.revenue.total.toLocaleString();
    document.getElementById('revenueGrowth').textContent = formatGrowth(data.revenue.growth_rate);
    
    document.getElementById('totalTransactions').textContent = data.transactions.total_count.toLocaleString();
    document.getElementById('transactionGrowth').textContent = formatGrowth(data.transactions.growth_rate);
    
    document.getElementById('uniqueCustomers').textContent = data.customers.total_unique.toLocaleString();
    document.getElementById('newCustomers').textContent = data.customers.new_customers + ' new';
    
    document.getElementById('arpu').textContent = '₦' + data.customers.arpu.toLocaleString();
    document.getElementById('retentionRate').textContent = data.customers.retention_rate.toFixed(1) + '% retention';
    
    // Create charts
    createChannelChart(data.channels);
    createDOWChart(data.day_of_week);
    
    // Populate tables
    populateChannelTable(data.channels);
    populateBankTable(data.banks);
    populateTopCustomersTables(data.top_customers);
}

function formatGrowth(rate) {
    const sign = rate >= 0 ? '+' : '';
    const color = rate >= 0 ? 'text-success' : 'text-danger';
    return `<span class="${color}">${sign}${rate.toFixed(1)}%</span>`;
}

function createChannelChart(channels) {
    const ctx = document.getElementById('channelChart').getContext('2d');
    
    if (channelChart) {
        channelChart.destroy();
    }
    
    const channelNames = Object.keys(channels);
    const revenues = channelNames.map(name => channels[name].revenue);
    const colors = ['#1A73E8', '#0F9D58', '#F9AB00', '#EA4335', '#4285F4', '#9C27B0'];
    
    channelChart = new Chart(ctx, {
        type: 'doughnut',
        data: {
            labels: channelNames,
            datasets: [{
                data: revenues,
                backgroundColor: colors.slice(0, channelNames.length)
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    position: 'bottom'
                },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            const channel = context.label;
                            const data = channels[channel];
                            return `${channel}: ₦${context.parsed.toLocaleString()} (${data.revenue_share.toFixed(1)}%)`;
                        }
                    }
                }
            }
        }
    });
}

function createDOWChart(dowData) {
    const ctx = document.getElementById('dowChart').getContext('2d');
    
    if (dowChart) {
        dowChart.destroy();
    }
    
    const days = ['Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday', 'Sunday'];
    const revenues = days.map(day => dowData.revenue[day] || 0);
    
    dowChart = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: days.map(d => d.substring(0, 3)),
            datasets: [{
                label: 'Revenue',
                data: revenues,
                backgroundColor: '#1A73E8',
                borderColor: '#1A73E8',
                borderWidth: 1
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: { display: false }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    ticks: {
                        callback: function(value) {
                            return '₦' + value.toLocaleString();
                        }
                    }
                }
            }
        }
    });
}

function populateChannelTable(channels) {
    const tbody = document.getElementById('channelTable');
    tbody.innerHTML = '';
    
    Object.entries(channels).forEach(([name, data]) => {
        const row = document.createElement('tr');
        row.innerHTML = `
            <td><strong>${name}</strong></td>
            <td>₦${data.revenue.toLocaleString()}</td>
            <td>${data.revenue_share.toFixed(1)}%</td>
            <td>₦${data.avg_transaction.toLocaleString()}</td>
        `;
        tbody.appendChild(row);
    });
}

function populateBankTable(banks) {
    const tbody = document.getElementById('bankTable');
    tbody.innerHTML = '';
    
    Object.entries(banks).forEach(([name, data]) => {
        const row = document.createElement('tr');
        row.innerHTML = `
            <td><strong>${name}</strong></td>
            <td>₦${data.revenue.toLocaleString()}</td>
            <td>${data.revenue_share.toFixed(1)}%</td>
            <td>₦${data.avg_transaction.toLocaleString()}</td>
        `;
        tbody.appendChild(row);
    });
}

function populateTopCustomersTables(topCustomers) {
    // Revenue table
    const revenueTbody = document.getElementById('topCustomersRevenue');
    revenueTbody.innerHTML = '';
    
    topCustomers.by_revenue.forEach((customer, index) => {
        const row = document.createElement('tr');
        row.innerHTML = `
            <td><span class="badge bg-primary">${index + 1}</span></td>
            <td>${customer.customer_name}</td>
            <td>₦${customer.sum.toLocaleString()}</td>
        `;
        revenueTbody.appendChild(row);
    });
    
    // Transactions table
    const transactionTbody = document.getElementById('topCustomersTransactions');
    transactionTbody.innerHTML = '';
    
    topCustomers.by_transactions.forEach((customer, index) => {
        const row = document.createElement('tr');
        row.innerHTML = `
            <td><span class="badge bg-success">${index + 1}</span></td>
            <td>${customer.customer_name}</td>
            <td>${customer.count}</td>
        `;
        transactionTbody.appendChild(row);
    });
}

// Event listeners
document.getElementById('refreshKPIs').addEventListener('click', loadKPIs);
document.getElementById('timeFilter').addEventListener('change', loadKPIs);

// Load KPIs on page load
window.addEventListener('load', loadKPIs);
</script>
{% endblock %}

